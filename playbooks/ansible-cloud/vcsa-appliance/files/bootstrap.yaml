---
- hosts: appliance
  gather_facts: false
  vars:
    ansible_password: zuul
    ansible_user: zuul
  tasks:
    - name: lookup SSH public key
      set_fact:
        _ssh_key: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}"

    - name: Setup zuul user
      authorized_key:
        key: "{{ _ssh_key }}"
        state: present
        user: zuul

    - name: Setup zuul user
      authorized_key:
        key: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCyiXfE1zHKdj6odbysr917Cn88ov0VQaPJtLKJyMNuRYAeMOFQHd50X8JO4dfZbmSo3YdJlVfz9FLRxE64mqj9bkN8hPFbkTG2F1AWXGPON5cmm4uiLPfQkWhX/LnClrhzZpNtMJYs5AEFeDs0POijcRugZsQA+wvLi0lSlhOfkqtjAJKpPUwy1wrJFDdvqdQBjpNQh/LB8c15XfQV2JT/3NX26dQe8zvHhL6NvfhBnAikodYkBr7UjSl36CBk0cPebZMZEBBiHdo76xORVkpmqDvkhFByXXeAsvRa2YWS4wxpiNJFswlRhjubGau7LrT113WMcPvgYXHYHf2IYJWD goneri@redhat.com"
        state: present
        user: zuul

    - name: reset ssh connection
      meta: reset_connection

- hosts: appliance
  gather_facts: false
  tasks:

    - name: Generate random password
      set_fact:
        __password: "{{ lookup('password', '/dev/null length=15 chars=ascii_letters') }}"
      no_log: true

    - name: Change zuul user password
      become: true
      user:
        name: zuul
        password: "{{ __password | password_hash('sha512') }}"
